// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum OrderStatus {
  PENDING
  PAID
  FULFILLED
  FAILED
}

enum LetterStatus {
  PENDING
  QUEUED
  SENDING
  SENT
  FAILED
}

model Order {
  id                      String   @id @default(uuid())
  stripeCheckoutSessionId String   @unique
  stripePaymentIntentId String?
  status                  OrderStatus @default(PENDING)
  email                   String?
  
  // Child details (from form)
  childName               String
  city                    String   // city_custom1
  goodDeed                String   // deed_custom2
  specialWish             String   // wish_custom3
  
  // Shipping address (JSON for flexibility)
  shippingAddress         Json?
  
  // Payment details
  amount                  Decimal  @default(39.99)
  currency                String   @default("USD")
  
  // Timestamps
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Schedule tracking
  originalSchedule        Json?
  adjustedSchedule        Json?
  
  // Relations
  letters                 Letter[]
}

model Letter {
  id                  String       @id @default(uuid())
  orderId             String
  sequenceNumber      Int          // 1, 2, or 3
  status              LetterStatus @default(PENDING)
  sendDate            DateTime
  sentDate            DateTime?
  handwryttenCardId   String?
  content             String       @db.Text // Full letter prose with variables
  
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  failedRecord        FailedLetter?
  
  @@index([orderId])
  @@index([status, sendDate])
}

model ProcessedStripeSession {
  id        String   @id @default(uuid())
  sessionId String   @unique
  createdAt DateTime @default(now())
}

model FailedLetter {
  id            String   @id @default(uuid())
  letterId      String   @unique
  error         String
  attempts      Json
  lastAttemptAt DateTime
  resolved      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  letter        Letter   @relation(fields: [letterId], references: [id], onDelete: Cascade)

  @@index([resolved, lastAttemptAt])
}
